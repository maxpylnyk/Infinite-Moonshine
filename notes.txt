Синхронизация

со стороны uno происходит проверка зависания, mega отвечает. 
если ответ не приходит - uno перезагружает mega.
если через ожидаемое время с uno не поступает сигнал - mega перезагружает uno
каждый контроллер имеет встроенную проверку на случай одновременного зависания

через больший промежуток времени проводится передача показаний всех сенсоров и управляющих элементов для записи в журнал.

если один из сенсоров или управляющих элементов вышел из строя - соответствующие данные будут равны нолю.

mega использует для отладки журнал serial
uno использует для записи файл на sd карте. имя файла YYYYMMDD.LOG
номер сессии хранится в памяти в виде uint32_t и синхронизируется.
после зависания в процессе работы сессия восстанавливается с этим номером


Журнал

хранит записи с меткой времени и данными сенсоров и управляющих устройств.
запись в журнал производится по завершению синхронизации с минимально необходимой периодичностью по интерфейсу spi.

после каждого этапа подводится итог выполнения - продолжительность, средние и ключевые значения данных.
при завершении сессии подводится общий итог.
в начале каждой сессии считываются итоги предыдущей как ожидаемые значения.
эти значения преобразовуются с учетом используемых закономерностей и принимают участие в инициализации
после этого система готова начать работу.
если сессия была отменена, в конце журнала производится соответствующая запись.


Этапы работы

ожидание

нагрев выключен. кран отбора закрыт, охлаждение включено. сессия неактивна.

нагрев

создается новая сессия, считываются данные предыдущей, передаются в соответствующие конструкторы.
охлаждение работает, кран отбора закрыт, кран возврата открыт на рабочее значение для отбора голов 300мл/ч.
нагрев максимальный. условие перехода на следующий этап - уровень флегмы достигает нижней отметки.

стабилизация

нагрев минимальный для кипения. измеряется температура пара и записывается в массив.
условие перехода на следующий этап - стабильность температуры в течение определенного времени.
ссылаться на табличную температуру + разница в большую сторону.

отбор головных фракций

кран отбора открыт. начальная скорость 100 мл/ч.
скачки температуры пара свидетельствуют о переохлаждении флегмы. температура холодильника 50°С.
уровень флегмы держится между отметками гидроуровня. контролируется нагревом. начальный нагрев минимален.
условие перехода на следующий этап - показания датчика алкоголя
кран отбора закрыт. дождаться вытока конденсата в приемную тару.

подготовка к отбору продукта

дождаться стабилизации тепмературы пара. она будет на 0.1-0.2°С выше.
запомнить значение как контрольную температуру. сравнить с табличной, вычислить погрешность.
сменить приемную тару.
условие перехода на следующий этап - стабилизация температуры пара.

отбор продукта

кран отбора открыт. начальная скорость 550 мл/ч. флегмовое число 3.
нагрев контролирует уровень флегмы.
если температура пара стабильна - запомнить значения и попробовать увеличить скорость отбора.
повторять до потери стабильности. вернуться к предыдущим значениям.
если температура пара возрастает на 0.1°С, закрыть кран отбора и дождаться стабилизации. 
если температура в трубе возрастает - уменьшать скорость отбора.
запоминать время стабилизации.
регистрировать изменения давления.
перепроверять контрольную температуру пара каждый час. для этого закрыть кран отбора и подождать стабилизации (измеренное время или 10 минут?)
условие перехода на следующий этап - возрастание температуры в трубе.

подготовка к завершению

закрыть кран отбора. уменьшить нагрев и скорость отбора, увеличить флегмовое число. подождать стабилизации.
при отладке использовать отдельную приемную тару.
условие перехода на следующий этап - температура в трубе не уменьшается.

завершение

кран отбора закрыт, кран возврата открыт на максимум. нагрев выключен.
дождаться падения температуры в трубе на 2°С. вернуть краны и переключатель тары в начальное положение.
записать в журнал итоги.

ошибка

независимо от этапа выполняется проверка переполнения гидроуровня и доступности функциональных элементов системы.
если происходит переполнение, нагрев выключается и кран возврата открывается на полную. ожидается уменьшение уровня флегмы ниже верхнего значения,
после чего включается уменьшенный нагрев. краны возвращаются в рабочее положение.


Критические условия

Остановить процесс с записью в журнал, если
ход крана охлаждения достиг предела, но температура флегмы не понижается
сработал датчик переполнения
любой из элементов не отвечает, элементы управления не реагируют на команды
error state active, show malfunction message


Максимум

кран отбора -> уменьшить нагрев
реле -> остановить алгоритм поиска
кран возврата -> уменьшить нагрев
кран охлаждения -> уменьшить нагрев






common
ссылки Class * object; oblect->method();
string в библиотеках #include "Arduino.h" только в хедер
int -> int32_t, int16_t -> int, #include "stdint.h"
все расчеты с промежуточными переменными





sensors
edit pin map
measure init, request and receive time, and values in debug methods

alc: init debug, measure time, optimize and calibrate levels
hlev: init, test getsyncarray, fit resistors
bar: debug
therm: debug 
mtr: calibrate maxPosition, mlToSteps, test fullstep mode
heater: debug calibrate, default adjStep, powerHead, powerBody



pin map

//bar		3.3V GND 20 21
//tr 		2
ssr		3
//alc		4 a0
//hlvl	5 a1 a2 a3
mtr 	22-37
spi		50-53
reset pin 49 @ MEGA, a5 @ UNO
megaSlaveSelect 4 @ UNO

UNO
13	SCK
12	MISO
11	MOSI
10	SS

MEGA
44-46	PWM
50	MISO
51	MOSI
52	SCK
53	SS




control

реечная передача
	рейка 20 см
	скорость 6 мм/с
	ширина зубьев рейки 6 мм
прямозубая передача
	передаточное число 2..6 кпд 95-97%
		4
		шаг 1.57

акрил
	коэф пуассона 0,37
	модуль юнга (упругости) 3300 МПа
	HRC твердость по роквеллу 95

двигатель

0.0805 Нм 1 Вт потребление	0.1484 Вт мощность
0.0586 Нм	1.28 Вт потребление	0.1012 Вт мощность

	момент	0,1194 Нм полшага	12 об/мин
					0,1592 Нм полный шаг 6 об/мин

Модуль m = 1.5
Число зубьев шестерни z1 = 9
Число зубьев колеса z2 = 36
Диаметр делительной окружности шестерни = 13.5
Диаметр делительной окружности колеса = 54
Высота зуба = 3.375
Диаметр окружности выступов шестерни = 16.5
Диаметр окружности выступов колеса = 57
Диаметр окружности впадин шестерни = 9.75
Диаметр окружности впадин колеса = 50.25
Толщина зуба по дуге делительной окружности = 2.356194
Межосевое расстояние = 33.75


Including files from the libraries folder, and subfolders, uses <> around the path/file name.

Including files from the sketch folder, and subfolders, uses "" around the path/file name.


states
session + time counter + src vol + output counter




sync
timer - provides log stamp and time measurements. 
logger - serial @ mega and writes file @ uno

init & restart logic

normal operation
0000	offline
0001	online
0011	transfer required

restart
0111	other restarted and transfer required

initialization
1001	initialization // uno after turning on
1011	init and transfer required // mega waiting for cmd after turning on




make flags volatile
introduce waitdog
if callsign incorrect -> ask again -> restart if incorrect
fill data
uno transfer byte delay -> wait
config pins @ setup
inherit sync for control



transfer 44B

state	1B	uint8_t

ONLINE					xxxxxxx1
TRANSFER				xxxxxx1x
RESTART					xxxxx1xx
INITIALIZATION 	xxxx1xxx

STAND_BY_STATE	0000xxxx
HEAT_STATE			0001xxxx	returnTap
STAB_STATE     	0010xxxx	minHeat
HEAD_STATE     	0011xxxx	outTap, headHeat
PRE_BODY_STATE 	0100xxxx	
BODY_STATE     	0101xxxx	outTap, bodyHeat
PRE_TAIL_STATE 	0110xxxx	outTap, rf, tailHeat
FINISH_STATE		0111xxxx

CANCEL_STATE		1000xxxx
ERROR_STATE   	1111xxxx

rf-sw-lo-hi-over	1B	uint8_t
	lo		xxxxxxx1
	hi		xxxxxx1x
	over	xxxxx1xx
	sw		xxxx1xxx
	rf		0011xxxx

alc		2B	int16_t	raw sensor value
tr1		4B	float
tr2		4B	float
tr3		4B	float
pres	12B	float float	float pres envTemp tblTemp
heat	2B	uint8_t uint8_t power adjStep
mtr1	2B	int16_t
mtr2	2B	int16_t
mtr3	2B	int16_t
adjExt	2B	int16_t
adjCool	2B	int16_t
sesN	4B	uint32_t





ui

utftglue::settextcursor выравнивание

numeric keyboard and input pane
info pane
settings pane
график выбранного параметра с маштабированием
отображение значения при нажатии

buttons
cancel
info
log
settings
plus
minus
up
down
left
right

keyboard

indicate panes and switch handle code
fillCircle with radius==1 -> drawPixel





log
IMTime time
IMLogger sd 20181207 8.3 .LOG
синхронизация и запись на sd карту одновременно

log structure:

time unsigned long 4B as integer
state	uint8_t 1B	as binary
rf-sw-lo-hi-ovr uint8_t 1B as binary
alc int16_t 2B as integer
tr1		4B	float	as decimal
tr2		4B	float	as decimal
tr3		4B	float	as decimal
pres	12B	float float	float pres envTemp tblTemp as decimal
heat	2B	uint8_t uint8_t power adjStep as integer
mtr1	2B	int16_t	as integer
mtr2	2B	int16_t	as integer
mtr3	2B	int16_t as integer
adjExt	2B	int16_t	as integer
adjCool	2B	int16_t	as integer

state init values

heat	uint8_t 1B as integer
outTap int16_t 2B as integer
returnTap int16_t 2B as integer
rf	uint8_t 1B as integer




logic
rfratio based control
reflux ratio = 3
InfiniteMoonshine from sync sketh

управление с измеренной инерционностью
запоминать стабильное значение
форсировать стабильные значения при отборе тела по команде
проследить зависимость охлаждения от температуры среды
исследовать различие фактической температуры кипения спирта от табличной
измерить время ответа на изменение мощности нагрева,
 скорости отбора, обратного отбора, охлаждения, выхода продукта из доохладителя
измерить минимальную мощность нагрева
если в течение расчетного времени + задержка не появляется нагрев - вывести ошибку no heat
предусмотреть сообщения о выходе из строя компонентов




manual mode






sync outside classes

IMUNO -> receives array
barometer
timer
logger 
ui

IMMEGA -> transmits array

//debug mode : Serial.begin();

alc, hlevel, therms
heater and motors
state -> init(), loop(), logic