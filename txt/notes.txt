Синхронизация

со стороны nano происходит проверка зависания, mega отвечает. 
если ответ не приходит - uno перезагружает mega.
если через ожидаемое время с uno не поступает сигнал - mega перезагружает uno
каждый контроллер имеет встроенную проверку на случай одновременного зависания

через больший промежуток времени проводится передача показаний всех сенсоров и управляющих элементов для записи в журнал.

если один из сенсоров или управляющих элементов вышел из строя - соответствующие данные будут равны нолю.

mega использует для отладки журнал serial
uno использует для записи файл на sd карте. имя файла YYYYMMDD.LOG
номер сессии хранится в памяти в виде uint32_t и синхронизируется.
после зависания в процессе работы сессия восстанавливается с этим номером


Журнал

хранит записи с меткой времени и данными сенсоров и управляющих устройств.
запись в журнал производится по завершению синхронизации с минимально необходимой периодичностью.

после каждого этапа подводится итог выполнения - продолжительность, средние и ключевые значения данных.
при завершении сессии подводится общий итог.
в начале каждой сессии считываются итоги предыдущей как ожидаемые значения.
эти значения преобразовуются с учетом используемых закономерностей и принимают участие в инициализации
после этого система готова начать работу.
если сессия была отменена, в конце журнала производится соответствующая запись.


Этапы работы

ожидание

нагрев выключен. кран отбора закрыт, охлаждение включено. сессия неактивна.

нагрев

создается новая сессия, считываются данные предыдущей, передаются в соответствующие конструкторы.
охлаждение работает, кран отбора закрыт, кран возврата открыт на рабочее значение для отбора голов 300мл/ч.
нагрев максимальный. условие перехода на следующий этап - уровень флегмы достигает нижней отметки.

стабилизация

нагрев минимальный для кипения. измеряется температура пара и записывается в массив.
условие перехода на следующий этап - стабильность температуры в течение определенного времени.
ссылаться на табличную температуру + разница в большую сторону.

отбор головных фракций

кран отбора открыт. начальная скорость 100 мл/ч.
скачки температуры пара свидетельствуют о переохлаждении флегмы. температура холодильника 50°С.
уровень флегмы держится между отметками гидроуровня. контролируется нагревом. начальный нагрев минимален.
условие перехода на следующий этап - показания датчика алкоголя
переход - кран отбора закрыт. дождаться вытока конденсата в приемную тару.

подготовка к отбору продукта

дождаться стабилизации тепмературы пара. она будет на 0.1-0.2°С выше.
запомнить значение как контрольную температуру. сравнить с табличной, вычислить погрешность.
сменить приемную тару.
условие перехода на следующий этап - стабилизация температуры пара.

отбор продукта

кран отбора открыт. начальная скорость 550 мл/ч. флегмовое число 3.
нагрев контролирует уровень флегмы.
если температура пара стабильна - запомнить значения и попробовать увеличить скорость отбора.
повторять до потери стабильности. вернуться к предыдущим значениям.
если температура пара возрастает на 0.1°С, закрыть кран отбора и дождаться стабилизации. 
если температура в трубе возрастает - уменьшать скорость отбора.
запоминать время стабилизации.
регистрировать изменения давления.
перепроверять контрольную температуру пара каждый час. для этого закрыть кран отбора и подождать стабилизации (измеренное время или 10 минут?)
условие перехода на следующий этап - возрастание температуры в трубе.

подготовка к завершению

закрыть кран отбора. уменьшить нагрев и скорость отбора, увеличить флегмовое число. подождать стабилизации.
при отладке использовать отдельную приемную тару.
условие перехода на следующий этап - температура в трубе не уменьшается.

завершение

кран отбора закрыт, кран возврата открыт на максимум. нагрев выключен.
дождаться падения температуры в трубе на 2°С. вернуть краны и переключатель тары в начальное положение.
записать в журнал итоги.

ошибка

независимо от этапа выполняется проверка переполнения гидроуровня и доступности функциональных элементов системы.
если происходит переполнение, нагрев выключается и кран возврата открывается на полную. ожидается уменьшение уровня флегмы ниже верхнего значения,
после чего включается уменьшенный нагрев. краны возвращаются в рабочее положение.


Критические условия

Остановить процесс с записью в журнал, если
ход крана охлаждения достиг предела, но температура флегмы не понижается
сработал датчик переполнения
любой из элементов не отвечает, элементы управления не реагируют на команды
error state active, show malfunction message


Максимум

кран отбора -> уменьшить нагрев
реле -> остановить алгоритм поиска
кран возврата -> уменьшить нагрев
кран охлаждения -> уменьшить нагрев





****	common	****

ссылки Class * object; oblect->method(); прототипирование
String в библиотеках #include <Arduino.h>только в хедер
int -> int32_t, int16_t -> int, #include <stdint.h>
все расчеты с промежуточными переменными
не объявлять константы в виртуальных классах
полиморфизм не работает

Including files from the libraries folder, and subfolders,
 uses <> around the path/file name.

Including files from the sketch folder, and subfolders,
 uses "" around the path/file name.


ddrg configures pins io
portg write all pins
ping read all pins at the same time


12В ток питания 300 мА + 200 мА на мотор

реечная передача
	рейка 20 см
	скорость 6 мм/с
	ширина зубьев рейки 6 мм
прямозубая передача
	передаточное число 2..6 кпд 95-97%
		4
		шаг 1.57

двигатель

0.0805 Нм 1 Вт потребление	0.1484 Вт мощность
0.0586 Нм	1.28 Вт потребление	0.1012 Вт мощность

	момент	0,1194 Нм полшага	12 об/мин
					0,1592 Нм полный шаг 6 об/мин

Модуль m = 1.5
Число зубьев шестерни z1 = 9
Число зубьев колеса z2 = 36
Диаметр делительной окружности шестерни = 13.5
Диаметр делительной окружности колеса = 54
Высота зуба = 3.375
Диаметр окружности выступов шестерни = 16.5
Диаметр окружности выступов колеса = 57
Диаметр окружности впадин шестерни = 9.75
Диаметр окружности впадин колеса = 50.25
Толщина зуба по дуге делительной окружности = 2.356194
Межосевое расстояние = 33.75

const int XP=6,XM=A2,YP=A1,YM=7; //240x320 ID=0x9325
const int TS_LEFT=184,TS_RT=932,TS_TOP=939,TS_BOT=203;
PORTRAIT CALIBRATION     240 x 320
x = map(p.x, LEFT=184, RT=932, 0, 240)
y = map(p.y, TOP=939, BOT=203, 0, 320)
Touch Pin Wiring XP=6 XM=A2 YP=A1 YM=7
LANDSCAPE CALIBRATION    320 x 240
x = map(p.y, LEFT=939, RT=203, 0, 320)
y = map(p.x, TOP=932, BOT=184, 0, 240)




****	sync	****

i initialization	(just turned on)
* online	(normal operation)
> incoming data (normal operation)
r restarted	(if other restarted)

if callsign incorrect -> ask again -> restart if incorrect

transmit session name only after reboot
transmit state after change and reboot
blackout -> send full data

nano sends - mega answers
* - * online
* - i mega blackout -> restart


i - * nano blackout -> restart
i - i power on

> - no answer required
r - no answer required


**** nano sends:

callsigns
if no callsign on timeout -> attempts to connect -> if success continue
																								 -> if no answer restart, try again -> if success continue with r data
																								 																		-> if no answer error -> log and display

* -> * expected
		 i -> mega blackout error
i -> i  -> stby
		!i -> nano blackout error
r -> data to restarted



**** mega sends:

responds on callsigns. if ! i | * -> no answer
if no callsign on timeout -> attempts to connect -> if success continue
																								 -> if no answer restart, try again -> if success continue with r data
																								 																		-> if no answer error -> blink
sends > data when collected

*
i <- full data expected with >
r -> full data to restarted





****	logic	****

  condenser node : therm, motor
    receive env temp
  extraction node : two therms, three motors, heater, hlevel, alc
    rfratio control logic
    receive pres, calc table temp
    search optimal values





****	log	****

заголовок в логе с подписью значений
комментарии
три первых строки
class logentry
define log line length after calbrating all nodes
enum for log records
sd equal line length
no log when paused
частота записи в журнал должна быть не реже частоты смены позиции кранов
если последняя сессия была отменена, предлагать продолжить при старте новой

@ YYYY-MM-DD hh:mm:ss 255 2 5 1024 78.555 78.500 50.000 78.667 -20.000 745.00 500 50 1 255 255 6 700 1700 10 1 2 3 4



****	debug	****

error hadle flags

how to handle errors?
	BLACKOUTS и OVERFLOW решаются контроллером. сообщения только для статистики
	для остальных вывести сообщение и перкратить работу с записью о причине
	разрешенные ошибки удаляются из списка, неисправности остаются


управление с измеренной инерционностью
запоминать стабильное значение
форсировать стабильные значения при отборе тела по команде
окно при дестабилизации в ручном режиме с кнопкой форсировать
ожидая ответ, продолжать мониторинг и передачу данных
проследить зависимость охлаждения от температуры среды
исследовать различие фактической температуры кипения спирта от табличной
измерить время ответа на изменение мощности нагрева,
 скорости отбора, обратного отбора, охлаждения, выхода продукта из доохладителя
измерить минимальную мощность нагрева кипения
измерить минимальное время существенного изменения показателей для синхронизации и записи в журнал
если в течение расчетного времени + задержка не появляется нагрев - вывести ошибку no heat
предусмотреть сообщения о выходе из строя компонентов с кнопкой продолжить если возможно
проследить зависимость мощности нагрева от температуры среды или сырья. 
	если зависимости нет - прописать константы в классе нагревателя.
предхвост для зерновых
display heads and body in % of absolute
график выбранного параметра с маштабированием
отображение значения при нажатии
фон соответствует режиму работы
темный при ожидании

sync. test restart. test no connection
	работает только при перезагрузке мега -> test with empty mega loop
	имитировать ситуацию когда нано онлайн, а мега инит.
	нано присылает данные при инициализации мега
	проверить как они пройдут
	hardware serial block?


****	after research	****

if no space -> extract usefull data to exp file and remove oldest logs
внести изменения в печатную плату: 
		подвинуть левое верхнее отверстие на 0.5 мм влево
		все отверстия увеличить до 3.5 мм
		правое верхнее и левое нижнее отверстия обойти дорожками на 1 мм
		нужно больше места вокруг гаек
		добавить отверстия для земли гидроуровня 4 шт, датчика алкоголя 1 шт
		отдалить термодатчик на плате от шнуров

настройки: мощность нагревателя, язык
сохранить в файл
dash with counters




**** schedule ****

search algorhytm in function nodes
не ждать показаний алкодатчика в цикле

paused state for control values measurement and manual mode
manual mode -> nano controls pause. mega can't cancel it with control check
normal operation -> mega sets pause to check control values

отображать остаточный объём

heater: debug calibrate, default adjStep, powerHead, powerBody
определить линейный участок напряжений нагревателя

крышка алкодатчика - эпоксидная смола

new session from begining to end
warn about state borders

warnings and confirmation dialogs
new session dialog

adj doesn't work
achieve to reconnect sensors in loop
check thermometers status while executing




**** tap calibration ****

water tap
0
100
200
300		0
350		
400		20
450		40
500		80
550		160
600		250
650		350
700		450
750		530
800		720
900		900
1000	1050

ml(steps) = 0.0015 * steps * steps -0.287 * steps -104.24; if (steps <= 378) return 0;
steps(ml) = -0.000295 * ml * ml +0.875 * ml + 378;

extraction tap

500   0
600   0.3
700   1
800   2.5
900   4
1000	5
1100  9
1200  13
1300  17
1400  22
1500  29
1600  35

checkpoints:
100 ml/h -> 1.65 ml/min
300 ml/h -> 5 ml/min
700 ml/h -> 11.64 ml/min
2100 ml/h -> 35 ml/min

ml(steps) = 0.002 * steps * steps -2.42 * steps + 733; if (steps <= 637) return 0;
steps(ml) = -0.000221 * ml * ml +0.9 * ml + 637;




**** versions ****

0.6		sync
0.7		log
0.8		logic
0.9		stats
1.0		ui
1.1		errors handling
1.2		expenience